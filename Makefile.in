# SPDX-License-Identifier: GPL-2.0-only OR GPL-3.0-only
# Copyright (c) 2022 Brett Sheffield <bacs@librecast.net>

PREFIX ?= /usr/local
export PREFIX
LIBDIR := $(PREFIX)/lib
LIBFILE := lib${LIBNAME}.so
INCLUDEDIR := $(PREFIX)/include

ifeq ($(origin CC),default)
CC = @CC@
endif
export CC

#CFLAGS += @CFLAGS@
CFLAGS = -Wall -Wextra -pedantic
CFLAGS += -pipe
ifdef DEBUG
CFLAGS += -g -Og
else
CFLAGS += -O3 -DNDEBUG
endif
CFLAGS += -march=native -mpopcnt -ffast-math -funroll-loops -flto
export CFLAGS

CPPFLAGS += @CPPFLAGS@
export CPPFLAGS

all: src

install: all doc
	cd src && $(MAKE) $@
	cd doc && $(MAKE) $@

uninstall:
	cd src && $(MAKE) $@

.PHONY: clean realclean src test sparse examples

src examples:
	$(MAKE) -C $@

fixme:
	grep -n FIXME src/*.{c,h} test/*.{c,h}

todo:
	grep -n TODO src/*.{c,h} test/*.{c,h}

speedtest: src
	cd test && $(MAKE) $@

clean realclean:
	cd src && $(MAKE) $@
	cd test && $(MAKE) $@

sparse: clean
	CC=cgcc $(MAKE) src

clang: clean
	CC=clang $(MAKE) src

clangtest: clean
	CC=clang $(MAKE) test

gcc: clean all

check test sanitize: src
	cd test && $(MAKE) $@

%.test %.check %.debug: src
	cd test && $(MAKE) $@
