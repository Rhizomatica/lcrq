# SPDX-License-Identifier: GPL-2.0-only OR GPL-3.0-only
# Copyright (c) 2022 Brett Sheffield <bacs@librecast.net>

SHELL = /bin/sh
LIBNAME := @PACKAGE_NAME@
VERSION := @PACKAGE_VERSION@
ABIVERS := @PACKAGE_ABIVERS@
.SUFFIXES:
.SUFFIXES: .c .o
CFLAGS += -fPIC
CFLAGS += -I. -I../include
HEADERS = ../include/$(LIBNAME).h $(LIBNAME)_pvt.h $(sort $(wildcard ../include/$(LIBNAME)/*.h))
INSTALL ?= install
LDCONFIG ?= ldconfig
LDLIBS := @LIBSODIUM@
INSTALL_DATA := $(INSTALL) -m 644
PREFIX ?= /usr/local
LIBDIR := $(DESTDIR)$(PREFIX)/lib
INCLUDEDIR := $(DESTDIR)$(PREFIX)/include
OBJECTS := gf256.o lcrq.o matrix.o

SOFILES := lib$(LIBNAME).so
SOVFILES := $(foreach f,$(SOFILES),$f.$(VERSION))
ABIFILES := $(foreach f,$(SOFILES),$f.$(ABIVERS))

all: $(SOFILES)

lib$(LIBNAME).so: $(OBJECTS)
	$(CC) $(CFLAGS) -shared -Wl,-soname,lib$(LIBNAME).so.$(ABIVERS) -o $@ $^ $(LDLIBS)

%.o: %.c %.h $(HEADERS)

install: $(SOFILES)
	$(INSTALL) -d $(LIBDIR)
	$(INSTALL) -d $(INCLUDEDIR)
	$(INSTALL_DATA) lib$(LIBNAME).so $(LIBDIR)/lib$(LIBNAME).so.$(VERSION)
	cp -r ../include/* $(INCLUDEDIR)
	$(LDCONFIG) -n $(LIBDIR)
	ln -sf lib$(LIBNAME).so.$(ABIVERS) $(LIBDIR)/lib$(LIBNAME).so

.PHONY: clean realclean uninstall

uninstall:
	cd $(LIBDIR) && rm -f lib$(LIBNAME).so lib$(LIBNAME).so.$(ABIVERS) lib$(LIBNAME).so.$(VERSION)

clean:
	$(RM) *.o $(SOFILES) $(ABIFILES)

realclean: clean
